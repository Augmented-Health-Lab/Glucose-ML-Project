import os
import pandas as pd
import sys
from pathlib import Path

LIME_GREEN = "\033[92m"
LIGHT_RED = "\033[91m"
R = "\033[0m"

def clean_and_compute_metadata(df, subject_id):
    '''
    This function calculates the following for each subject:
      - Total number of glucose records
      - Compute average glucose level (mg/dL).
      - Duration of glucose data coverage in days (Counts each unique day with at least one glucose sample)
    '''

    #Ensure timestamp column in Pandas readable format.
    df['timestamp'] = pd.to_datetime(df['timestamp'])

    # Count number of different days with at least one glucose record
    count_days_with_CGM_data = df['timestamp'].dt.date.nunique()

    # Calculate total number of glucose records for the subject.
    glucose_level_record_count = len(df)

    # Calculate average glucose level for the subject from all readings.
    average_glucose_level_mg_dl = df['glucose_value_mg_dl'].mean()

    # Collect calculations to be reported.
    metadata = {
        "subject_id": subject_id,
        "glucose_level_record_count": glucose_level_record_count,
        "average_glucose_level_mg_dl": round(average_glucose_level_mg_dl, 2),
        "count_days_with_CGM_data": int(count_days_with_CGM_data),
    }


    return metadata


def main():
    '''
    This script calculates various subject-level CGM statistics from the CGMacros_Libre dataset that are reported in CGMacros_Libre_metadata.csv
    The following columns are calcualted in this script: glucose_level_record_count, average_glucose_level_mg_dl, glucose_data_duration_days
    
    Input: The directory of standardized data generated by CGMacros_Libre_extract-glucose-data.py.
    Output: "CGMacros_Libre_metadata_calcs.csv" file containing computed metadata for all subjects.
    '''

    if len(sys.argv) != 2:
        print("Invalid command. Usage: python CGMacros_Libre_extract-demographics.py <input_folder>")
        print("Tip: Make sure input folder contians the standardized outputs generated by CGMacros_Libre_extract-glucose-data.py")
        sys.exit(1)

    # Path to where the CGMacros_Libre_extract_extract-glucose-data.py output lives.
    input_path = Path(sys.argv[1])

    #bin to store calculations until needed for  output file generation.
    metadata_list = []

    # Loop through each subject CSV file and calculate output values for each subject.
    count = 0
    for subject in input_path.rglob("*.csv"):
        subject_id = subject.stem
        df = pd.read_csv(subject)
        metadata = clean_and_compute_metadata(df, subject_id)
        # Store output in bin until output file generation.
        metadata_list.append(metadata)
        count += 1

    # Save metadata for all subjects
    metadata_df = pd.DataFrame(metadata_list)
    print(f'Metadata calculated for {count} subjects')

    #Helper Regex function to order rows (numerically) by subject ID. Creates a temporary column "subject_num" to order subjects.
    metadata_df["subject_num"] = (metadata_df["subject_id"].str.extract(r"(\d+)").astype(int))
    metadata_df = metadata_df.sort_values("subject_num").drop(columns=["subject_num"])

    # Write metadata calculations to the output csv.
    metadata_df.to_csv("Standardized-metadata/CGMacros_Libre_metadata_calcs.csv", index=False)
    print(f"{LIME_GREEN}Glucose-ML{R}: Generated metadata for {LIGHT_RED}{len(metadata_df)}{R} subjects.")


if __name__ == "__main__":
    main()