import pandas as pd
from pathlib import Path
import sys

LIME_GREEN = "\033[92m"
LIGHT_RED = "\033[91m"
R = "\033[0m"

def clean_and_compute_metadata(df, subject_id):
    '''
    This function calculates the following for each subject:
      - Total number of glucose records
      - Compute average glucose level (mg/dL).
      - Duration of glucose data coverage in days (Counts each unique day with at least one glucose sample)
    '''
    #Ensure timestamp column in Pandas readable format.
    df['timestamp'] = pd.to_datetime(df['timestamp'])

    # Count number of different days with at least one glucose record
    count_days_with_CGM_data = df['timestamp'].dt.date.nunique()

    # Count total number of glucose records for the subject.
    glucose_level_record_count = len(df) 

    # Calculate the subjects average glucose level from all readings.
    average_glucose_level_mg_dl = df['glucose_value_mg_dl'].mean() #average of glucose column.

    # Collect calculations to be reported.
    metadata = {
        "subject_id": subject_id,
        "glucose_level_record_count": glucose_level_record_count,
        "average_glucose_level_mg_dl": round((average_glucose_level_mg_dl/18),2),
        "count_days_with_CGM_data": int(count_days_with_CGM_data),
    }


    return metadata


def main():
    '''
    This script calculates various subject-level CGM statistics from the D1NAMO dataset that are reported in D1NAMO_metadata.csv
    The following columns are calcualted in this script: glucose_level_record_count, average_glucose_level_mg_dl, glucose_data_duration_days

    Input: "Standardized-datasets/" directory of standardized data generated from the D1NAMO_extract-glucose-data.py.
    Output: "D1NAMO_metadata_calcs.csv" file containing computed metadata for all subjects.
    '''
    
    if len(sys.argv) != 2:
        print("Invalid command. Usage: python D1NAMO_extract-demographics.py <input_folder>")
        print("Tip: Make sure input folder contians the standardized outputs generated by D1NAMO_extract-glucose-data.py")
        sys.exit(1)

    # Path where D1NAMO_extract-glucose-data.py output was created.
    input_path = Path(sys.argv[1])
    #bin to store calculations until needed for  output file generation.
    metadata_list = []
    
    # Loop through each subject CSV file and calcualte output values for each subject.
    count = 0
    for subject in input_path.rglob("*.csv"):
        #pull subjectID from input csv to use as identifier for populating output.
        subject_id = subject.stem
        df = pd.read_csv(subject)
        metadata = clean_and_compute_metadata(df, subject_id)
        # Store output in bin until output file generation.
        metadata_list.append(metadata)
        count += 1
    print(f'Metadata calculated for {count} subjects')
    
    metadata_df = pd.DataFrame(metadata_list)
    #Order rows by subject ID.
    metadata_df = metadata_df.sort_values("subject_id")

    # Write metadata calculations to the output csv.
    metadata_df.to_csv("Standardized-metadata/D1NAMO_metadata_calcs.csv", index=False)
    print(f"{LIME_GREEN}Glucose-ML{R}: Generated metadata for {LIGHT_RED}{len(metadata_df)}{R} subjects.")

if __name__ == "__main__":
    main()