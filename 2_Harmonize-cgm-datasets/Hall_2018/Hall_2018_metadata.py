import pandas as pd
from pathlib import Path
import sys

LIME_GREEN = "\033[92m"
LIGHT_RED = "\033[91m"
R = "\033[0m"

def clean_and_compute_metadata(df, subject_id):
    '''
    This function calculates the following for each subject:
      - Total number of glucose records
      - Average glucose level (mg/dL), excluding 'Low'/'High' entries
      - Duration of glucose data coverage in days (Counts each unique day with at least one glucose sample)
    '''
    #Ensure timestamp column in Pandas readable format.
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    # Count number of different days with at least one glucose record
    count_days_with_CGM_data = df['timestamp'].dt.date.nunique()

    # Calculate total number of glucose records for the subject.
    glucose_level_record_count = len(df)

    # Replace Low/High values with None before converting to numeric for average glucose calculation.
    df['glucose_value_mg_dl'] = pd.to_numeric(df['glucose_value_mg_dl'].replace({'Low': None, 'High': None}), errors='coerce')

    # Calculate average glucose level for the subject from all readings.
    average_glucose_level_mg_dl = df['glucose_value_mg_dl'].mean()

    # Collect calculations to be reported.
    metadata = {
        "subject_id": subject_id,
        "glucose_level_record_count": glucose_level_record_count,
        "average_glucose_level_mg_dl": round(average_glucose_level_mg_dl, 2),
        "count_days_with_CGM_data": int(count_days_with_CGM_data),
    }

    return metadata


def main():
    '''
    This script calculates various subject-level CGM statistics from the Hall_2018 dataset that are reported in Hall_2018_metadata.csv
    The following columns are calcualted in this script: glucose_level_record_count, average_glucose_level_mg_dl, glucose_data_duration_days
    
    Input: The directory of standardized data generated by Hall_2018_extract-glucose-data.py.
    Output: "Hall_2018_metadata_calcs.csv" file containing computed metadata for all subjects.
    '''

    if len(sys.argv) != 2:
        print("Invalid command. Usage: python Hall_2018_extract-demographics.py <input_folder>")
        print("Tip: Make sure input folder contians the standardized outputs generated by Hall_2018_extract-glucose-data.py")
        sys.exit(1)

    # Path to where the Hall_2018_extract-glucose-data.py output lives.
    input_path = Path(sys.argv[1])

    #bin to store calculations until needed for  output file generation.
    metadata_list = []
    # Loop through each subject CSV file and calculate output values for each subject.
    for subject in input_path.rglob("*.csv"):
        subject_id = subject.stem
        df = pd.read_csv(subject)
        metadata = clean_and_compute_metadata(df, subject_id)
        # Store output in bin until output file generation.
        metadata_list.append(metadata)


    metadata_df = pd.DataFrame(metadata_list)
    #Order rows by subject ID.
    metadata_df = metadata_df.sort_values("subject_id")

    # Write metadata calculations to the output csv.
    metadata_df.to_csv("Standardized-metadata/Hall_2018_metadata_calcs.csv", index=False)
    print(f"{LIME_GREEN}Glucose-ML{R}: Generated metadata for {LIGHT_RED}{len(metadata_df)}{R} subjects.")


if __name__ == "__main__":
    main()
