import pandas as pd
import sys
from pathlib import Path


def clean_and_compute_metadata(df, subject_id):
    '''
    This function calculates the following for each subject:
      - Total number of glucose records
      - Average glucose level (mg/dL), excluding 'Low'/'High' entries
      - Duration of glucose data coverage in days (Counts each unique day with at least one glucose sample)
    '''
    #Ensure timestamp column in Pandas readable format.
    df['timestamp'] = pd.to_datetime(df['timestamp'])

    # Count number of different days with at least one glucose record
    count_days_with_CGM_data = df['timestamp'].dt.date.nunique()

    # Calculate total number of glucose records for the subject.
    glucose_level_record_count = len(df)

    # Replace Low/High values with None before converting to numeric for average glucose calculation.
    df['glucose_value_mg_dl'] = pd.to_numeric(df['glucose_value_mg_dl'].replace({'Low': None, 'High': None}), errors='coerce')

    # Calculate average glucose level for the subject from all readings.
    average_glucose_level_mg_dl = df['glucose_value_mg_dl'].mean()

    # Collect calculations to be reported.
    metadata = {
        "subject_id": subject_id,
        "glucose_level_record_count": glucose_level_record_count,
        "average_glucose_level_mg_dl": round(average_glucose_level_mg_dl, 2),
        "count_days_with_CGM_data": int(count_days_with_CGM_data),
    }


    return metadata


def main():
    '''
    This script calculates various subject-level CGM statistics from the PhysioCGM dataset that are reported in PhysioCGM_metadata.csv
    The following columns are calcualted in this script: glucose_level_record_count, average_glucose_level_mg_dl, glucose_data_duration_days
    
    Input: The directory of standardized data generated by PhysioCGM_extract-glucose-data.py.
    Output: "PhysioCGM_metadata_calcs.csv" file containing computed metadata for all subjects.
    '''

    if len(sys.argv) != 2:
        print("Invalid command. Usage: python PhysioCGM_extract-demographics.py <input_folder>")
        print("Also make sure input folder contians the standardized outputs generated by PhysioCGM_extract-glucose-data.py")
        sys.exit(1)

    # Path to where the PhysioCGM_extract-glucose-data.py output lives.
    input_path = Path(sys.argv[1])

    metadata_list = []
    for subject in input_path.rglob("*.csv"):
        print(subject)
        subject_id = subject.stem
        df = pd.read_csv(subject)
        metadata = clean_and_compute_metadata(df, subject_id)
        metadata_list.append(metadata)
    # Save metadata for all subjects
    metadata_df = pd.DataFrame(metadata_list)

    #Helper Regex function to order rows (numerically) by subject ID. Creates a temporary column "subject_num" to order subjects.
    metadata_df[["cohort_num", "subject_num"]] = (metadata_df["subject_id"].str.extract(r"c(\d+)s(\d+)").astype(int))
    metadata_df = (metadata_df.sort_values(["cohort_num", "subject_num"]).drop(columns=["cohort_num", "subject_num"]))


    metadata_df.to_csv("Standardized-metadata/PhysioCGM_metadata_calcs.csv", index=False)

if __name__ == "__main__":
    main()